{% extends 'base.html' %}
{% block content %}
<div class="max-w-3xl mx-auto mt-6 px-3 sm:px-4">

  <!-- Header -->
  <header class="rounded-2xl ring-1 ring-slate-200 shadow-sm bg-white p-5 sm:p-6 mb-6">
    <div class="flex items-center justify-between">
      <h1 class="text-2xl sm:text-3xl font-extrabold text-slate-900">Settings</h1>
      <a href="/" class="text-sm text-slate-600 hover:text-slate-900">← Back</a>
    </div>
    <p class="mt-1 text-slate-600">Update your account details, manage your plan, and read the legal stuff.</p>
  </header>

  {% if messages %}
  <div class="space-y-2 mb-4">
    {% for message in messages %}
      <div class="rounded-xl px-3 py-2 text-sm
                  {% if message.tags == 'success' %} bg-emerald-50 text-emerald-800 ring-1 ring-emerald-200
                  {% elif message.tags == 'error' %} bg-rose-50 text-rose-800 ring-1 ring-rose-200
                  {% else %} bg-slate-50 text-slate-800 ring-1 ring-slate-200 {% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Grid: Compte + Plan -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
    <!-- Compte -->
    <section class="md:col-span-2 rounded-2xl ring-1 ring-slate-200 bg-white p-5 sm:p-6 shadow-sm">
      <h2 class="text-lg font-bold text-slate-900">Account</h2>
      <form method="post" action="{% url 'settings' %}" class="mt-4 space-y-4">
        {% csrf_token %}
        <div>
          <label class="block text-sm font-medium text-slate-700">Username</label>
          {{ form.username }}
          {% if form.username.errors %}
            <p class="mt-1 text-sm text-rose-600">{{ form.username.errors.0 }}</p>
          {% endif %}
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700">Email</label>
          {{ form.email }}
          {% if form.email.errors %}
            <p class="mt-1 text-sm text-rose-600">{{ form.email.errors.0 }}</p>
          {% endif %}
        </div>
        <div class="flex flex-col sm:flex-row gap-2 pt-2">
          <button type="submit"
                  class="inline-flex justify-center items-center gap-2 bg-[#1e3a8a] text-white font-semibold px-4 py-2.5 rounded-xl hover:brightness-110">
            Save changes
          </button>
          <a href="{% url 'settings_password' %}"
             class="inline-flex justify-center items-center gap-2 border border-slate-200 text-slate-700 px-4 py-2.5 rounded-xl hover:bg-slate-50">
            Change password
          </a>
          <a href="{% url 'logout' %}" class="inline-flex justify-center items-center gap-2 text-slate-500 px-4 py-2.5 rounded-xl hover:bg-slate-50">
            Logout
          </a>
        </div>
      </form>
    </section>

    <!-- Plan -->
    <aside class="rounded-2xl ring-1 ring-slate-200 bg-white p-5 sm:p-6 shadow-sm">
      <h2 class="text-lg font-bold text-slate-900">Plan</h2>
      <div class="mt-2 text-slate-700 space-y-1">
        <div class="text-sm"><span class="font-semibold">Subscription:</span> <span class="uppercase">{{ subscription }}</span></div>
        <div class="text-sm"><span class="font-semibold">Credits:</span> {{ credits }}</div>
        <div class="text-sm"><span class="font-semibold">Last audio reset:</span> {{ last_audio_reset|date:"d/m/Y H:i" }}</div>
      </div>

      <div class="mt-4">
        <div class="text-xs text-slate-500 mb-1">Monthly usage</div>
        <div class="h-2.5 w-full bg-slate-200 rounded-full overflow-hidden">
          <div id="quota-bar" class="h-full w-0 bg-gradient-to-r from-[#1e3a8a] to-[#3b82f6] transition-[width] duration-500"></div>
        </div>
        <div id="quota-detail" class="text-xs text-slate-500 mt-1"></div>
      </div>

      <div class="mt-4 flex flex-col gap-2">
        <a href="/#pricing" class="inline-flex items-center gap-2 text-[#1e3a8a] font-semibold hover:underline">Upgrade plan →</a>

        {% if subscription|lower != 'free' %}
        <!-- Danger: Annuler l'abonnement -->
        <form method="post" action="{% url 'cancel_subscription' %}" onsubmit="return confirmCancel()">
          {% csrf_token %}
          <button type="submit"
                  class="w-full inline-flex justify-center items-center gap-2 bg-rose-600 font-semibold px-4 py-2 rounded-xl hover:brightness-110"style="color: red; border: 1px solid #f87171; ">
            Annuler l’abonnement
          </button>
          <p class="mt-1 text-[11px] text-slate-500">
            L’annulation prend effet à la fin de la période en cours. Vos données restent accessibles sur le plan Free.
          </p>
        </form>
        {% endif %}
      </div>
    </aside>
  </div>

  <!-- Légal & conformité -->
  <section class="mt-6 rounded-2xl ring-1 ring-slate-200 bg-white p-5 sm:p-6 shadow-sm">
    <h2 class="text-lg font-bold text-slate-900">Legal & Compliance</h2>
    <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
      <a class="block rounded-xl border border-slate-200 p-4 hover:bg-slate-50" href="{% url 'legal_terms' %}">
        <div class="font-semibold text-slate-900">Conditions d’utilisation</div>
        <div class="text-sm text-slate-600">CGU / CGV</div>
      </a>
      <a class="block rounded-xl border border-slate-200 p-4 hover:bg-slate-50" href="{% url 'legal_privacy' %}">
        <div class="font-semibold text-slate-900">Politique de confidentialité</div>
        <div class="text-sm text-slate-600">Données, cookies, RGPD</div>
      </a>
      <a class="block rounded-xl border border-slate-200 p-4 hover:bg-slate-50" href="{% url 'legal_refunds' %}">
        <div class="font-semibold text-slate-900">Remboursements</div>
        <div class="text-sm text-slate-600">Essais, annulations, remboursements</div>
      </a>
      <a class="block rounded-xl border border-slate-200 p-4 hover:bg-slate-50" href="{% url 'legal_imprint' %}">
        <div class="font-semibold text-slate-900">Mentions légales</div>
        <div class="text-sm text-slate-600">Éditeur, contact, hébergeur</div>
      </a>
    </div>
  </section>

</div>

<script>
(function(){
  // Barre d’usage
  const plan = "{{ subscription|lower }}";
  const total = (plan==='free') ? 180 : (plan==='student' ? 600 : (plan==='pro' ? 1200 : 600));
  const used = 0; // remplace par ta vraie conso si tu l’as
  const pct = Math.max(0, Math.min(100, Math.round(used/total*100)));
  const bar = document.getElementById('quota-bar');
  const det = document.getElementById('quota-detail');
  if(bar) bar.style.width = pct + '%';
  if(det) det.textContent = (plan==='free'?'Lifetime ':'Monthly ') + (total/60)+'h total • used '+Math.floor(used/60)+'h '+(used%60)+'m ('+pct+'%)';
})();
function confirmCancel(){
  return confirm("Confirmer l’annulation de l’abonnement ? Vous conserverez l’accès jusqu’à la fin de la période en cours.");
}
</script>
{% endblock %}
