{% extends 'base.html' %}
{% block content %}

<div class="max-w-md mx-auto mt-8 px-4">
  <!-- Card -->
  <div class="bg-white rounded-2xl ring-1 ring-slate-200 shadow-sm p-6">
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-extrabold text-slate-900">Change password</h1>
      <a href="{% url 'settings' %}" class="text-sm text-slate-600 hover:text-slate-900">← Back</a>
    </div>
    <p class="mt-1 text-slate-600">Choose a strong password you don’t use elsewhere.</p>

    <!-- Non field errors -->
    {% if form.non_field_errors %}
      <div class="mt-4 rounded-xl bg-rose-50 text-rose-800 ring-1 ring-rose-200 px-3 py-2 text-sm">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    <form id="password-form" method="post" class="mt-5 space-y-4">
      {% csrf_token %}

      <!-- Old password -->
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">
          {{ form.old_password.label|default:"Old password" }}
        </label>
        <div class="relative">
          {{ form.old_password }}
          <button type="button" data-toggle="#id_old_password"
                  class="toggle-btn">Show</button>
        </div>
        {% if form.old_password.errors %}
          <p class="mt-1 text-sm text-rose-600">{{ form.old_password.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- New password -->
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">
          {{ form.new_password1.label|default:"New password" }}
        </label>
        <div class="relative">
          {{ form.new_password1 }}
          <button type="button" data-toggle="#id_new_password1"
                  class="toggle-btn">Show</button>
        </div>

        <!-- Strength meter -->
        <div class="mt-2">
          <div class="h-2 w-full bg-slate-200 rounded-full overflow-hidden">
            <div id="pw-strength" class="h-full w-0 rounded-full"></div>
          </div>
          <div id="pw-hint" class="mt-1 text-xs text-slate-500"></div>
        </div>

        {% if form.new_password1.help_text %}
          <div class="mt-2 text-xs text-slate-500 leading-5">
            {{ form.new_password1.help_text|safe }}
          </div>
        {% endif %}
        {% if form.new_password1.errors %}
          <p class="mt-1 text-sm text-rose-600">{{ form.new_password1.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- Confirm -->
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">
          {{ form.new_password2.label|default:"New password confirmation" }}
        </label>
        <div class="relative">
          {{ form.new_password2 }}
          <button type="button" data-toggle="#id_new_password2"
                  class="toggle-btn">Show</button>
        </div>
        {% if form.new_password2.errors %}
          <p class="mt-1 text-sm text-rose-600">{{ form.new_password2.errors.0 }}</p>
        {% endif %}
      </div>

      <button class="w-full bg-[#1e3a8a] text-white font-semibold px-4 py-2.5 rounded-xl hover:brightness-110">
        Update
      </button>
    </form>
  </div>
</div>

<style>
  /* Style les <input> générés par le PasswordChangeView sans widget_tweaks */
  #password-form input[type="password"]{
    width:100%; border:1px solid #e5e7eb; border-radius:0.75rem;
    padding:.6rem .9rem; outline:0; color:#0f172a; background:#fff;
  }
  #password-form input[type="password"]:focus{
    border-color:#bfdbfe; box-shadow:0 0 0 3px rgba(30,58,138,.15);
  }
  /* Bouton show/hide */
  .toggle-btn{
    position:absolute; right:.5rem; top:50%; transform:translateY(-50%);
    font-size:.8rem; padding:.25rem .5rem; border-radius:.5rem;
    border:1px solid #e5e7eb; background:#f8fafc; color:#334155;
  }
  .toggle-btn:hover{ background:#f1f5f9; }
</style>

<script>
(function(){
  // Toggle show/hide
  document.querySelectorAll('.toggle-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const sel = btn.getAttribute('data-toggle');
      const input = document.querySelector(sel);
      if(!input) return;
      input.type = input.type === 'password' ? 'text' : 'password';
      btn.textContent = input.type === 'password' ? 'Show' : 'Hide';
    });
  });

  // Strength meter (simple mais utile)
  const pw = document.querySelector('#id_new_password1');
  const bar = document.querySelector('#pw-strength');
  const hint = document.querySelector('#pw-hint');

  function scorePassword(v){
    let s = 0;
    if(!v) return 0;
    // longueur
    if (v.length >= 12) s += 2;
    else if (v.length >= 8) s += 1;
    // diversité
    if (/[a-z]/.test(v) && /[A-Z]/.test(v)) s += 1;
    if (/\d/.test(v)) s += 1;
    if (/[^A-Za-z0-9]/.test(v)) s += 1;
    // pénalité patterns simples
    if (/^(?:\d+|[a-z]+)$/i.test(v)) s -= 1;
    return Math.max(0, Math.min(5, s));
  }

  function renderStrength(s){
    const pct = [0, 20, 40, 60, 80, 100][s];
    const colors = ['#e5e7eb','#fca5a5','#fbbf24','#60a5fa','#34d399','#16a34a'];
    bar.style.width = pct + '%';
    bar.style.background = colors[s];
    const labels = ['','Very weak','Weak','Okay','Good','Strong'];
    hint.textContent = labels[s];
  }

  if(pw){
    pw.addEventListener('input', ()=> renderStrength(scorePassword(pw.value)));
    renderStrength(0);
  }
})();
</script>

{% endblock %}
