{% extends 'base.html' %}
{% block content %}

<!-- Improved container with better mobile spacing -->
<div class="max-w-4xl mx-auto mt-4 px-4 sm:mt-6 sm:px-6">

  <!-- Enhanced hero section with better mobile layout -->
  <header class="relative overflow-hidden rounded-xl sm:rounded-2xl ring-1 ring-slate-200 shadow-md mb-4 sm:mb-6 bg-white">
    <div class="p-4 sm:p-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 sm:gap-4">
        <div class="min-w-0">
          <h1 class="text-xl sm:text-2xl md:text-3xl font-extrabold tracking-tight text-slate-900 leading-tight">
            Welcome, {{ user.username }}!
          </h1>
          <p class="mt-1 text-sm sm:text-base text-slate-600 leading-relaxed">
            Your workspace to upload, track processing, and study smarter.
          </p>
        </div>

        <!-- Improved mobile-first button layout with better touch targets -->
        <div class="flex flex-col gap-2 w-full md:w-auto md:flex-row md:gap-3">
          <a href="/upload_course/" style="color: black;"
             class="inline-flex items-center justify-center gap-2 w-full md:w-auto
                    bg-[#1e3a8a] text-white font-semibold px-5 py-3 rounded-xl
                    hover:bg-[#1e40af] active:bg-[#1d4ed8] transition-colors
                    shadow-sm hover:shadow-md min-h-[44px] text-sm sm:text-base">
            <span class="text-base" style="color: black;">‚¨ÜÔ∏è</span> Upload a course
          </a>
          <div class="flex gap-2 w-full md:w-auto">
            <a href="/settings/"
               class="inline-flex items-center justify-center gap-2 flex-1 md:flex-none md:w-auto
                      border border-slate-200 text-slate-700 font-semibold px-4 py-3 rounded-xl
                      hover:bg-slate-50 active:bg-slate-100 transition-colors
                      min-h-[44px] text-sm sm:text-base">
              <span class="text-base">‚öôÔ∏è</span> Settings
            </a>
            <a href="/"
               class="inline-flex items-center justify-center gap-2 flex-1 md:flex-none md:w-auto
                      border border-slate-200 text-slate-700 font-semibold px-4 py-3 rounded-xl
                      hover:bg-slate-50 active:bg-slate-100 transition-colors
                      min-h-[44px] text-sm sm:text-base">
              <span class="text-base">üè†</span> Home
            </a>
          </div>
        </div>
      </div>

      <!-- Better mobile layout for status pills -->
      <div class="mt-4 flex flex-col sm:flex-row sm:flex-wrap gap-2">
        <span class="inline-flex items-center gap-2 px-3 py-2 rounded-full bg-slate-100 text-slate-700 text-sm font-medium">
          <span class="text-base">üîî</span> Plan: <b class="tracking-wide uppercase">{{ user.subscription }}</b>
        </span>
        <span class="inline-flex items-center gap-2 px-3 py-2 rounded-full bg-indigo-50 text-indigo-800 text-sm font-medium">
          <span class="text-base">‚è≥</span> Remaining: <b id="remain-label">{{ remaining_hours }}h {{ remaining_minutes }}min</b>
        </span>
      </div>
    </div>
  </header>

  <!-- Enhanced subscription section with better mobile spacing -->
  <section class="mb-4 sm:mb-6 bg-white rounded-xl sm:rounded-2xl p-4 sm:p-5 ring-1 ring-slate-200 shadow-sm">
    <div class="flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between">
      <div class="min-w-0">
        <div class="text-slate-900 text-lg sm:text-xl font-bold">Subscription</div>
        <div class="text-slate-600 mt-1">
          <span class="uppercase font-semibold text-sm sm:text-base">{{ user.subscription }}</span>
          {% if user.subscription == 'free' %}<span class="text-xs text-gray-500 block sm:inline"> ‚Ä¢ 3h/month</span>{% endif %}
          {% if user.subscription == 'student' %}<span class="text-xs text-gray-500 block sm:inline"> ‚Ä¢ 10h/month</span>{% endif %}
          {% if user.subscription == 'pro' %}<span class="text-xs text-gray-500 block sm:inline"> ‚Ä¢ 20h/month</span>{% endif %}
        </div>
      </div>
      <div class="min-w-0 w-full sm:w-auto sm:min-w-[240px]">
        <div class="text-xs text-slate-500 mb-2 font-medium">Monthly usage</div>
        <div class="h-3 w-full bg-slate-200 rounded-full overflow-hidden">
          <div id="quota-bar" class="h-full w-0 bg-gradient-to-r from-[#1e3a8a] to-[#3b82f6] transition-[width] duration-700 ease-out"></div>
        </div>
        <div id="quota-detail" class="text-xs text-slate-500 mt-2"></div>
      </div>
    </div>
  </section>

  <!-- Improved search header with better mobile layout -->
  <div class="mb-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
    <h2 class="text-xl sm:text-2xl font-bold text-slate-900">Your Courses</h2>
    <div class="relative">
      <input id="course-search" type="search" placeholder="Search courses‚Ä¶"
             class="w-full sm:w-80 px-4 py-3 pl-10 rounded-xl border border-slate-200
                    focus:outline-none focus:ring-2 focus:ring-[#1e3a8a]/40 focus:border-[#1e3a8a]
                    text-sm sm:text-base transition-colors">
      <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </div>
    </div>
  </div>

  <!-- Enhanced courses grid with better mobile cards -->
  {% if courses %}
  <ul id="course-grid" class="grid gap-3 sm:gap-4 sm:grid-cols-2">
    {% for course in courses %}
    <li class="group relative rounded-xl sm:rounded-2xl p-4 sm:p-5 ring-1 ring-slate-200 bg-white 
               shadow-sm hover:shadow-md hover:ring-slate-300 transition-all duration-200
               active:scale-[0.98] sm:active:scale-100"
        data-title="{{ course.title|lower }}">
      <a href="{% url 'course_detail' course.id %}" class="block">
        <!-- Better positioned badge with improved styling -->
        <div class="absolute top-3 right-3 sm:top-4 sm:right-4">
          {% if course.processing %}
            <span class="inline-flex items-center gap-1.5 text-xs px-2.5 py-1 rounded-full border border-blue-200 text-blue-700 bg-blue-50 font-medium">
              <span class="inline-block w-2 h-2 border-2 border-blue-300 border-t-blue-700 rounded-full animate-spin"></span>
              Processing
            </span>
          {% else %}
            <span class="inline-flex items-center text-xs px-2.5 py-1 rounded-full border border-emerald-200 text-emerald-700 bg-emerald-50 font-medium">
              ‚úì Ready
            </span>
          {% endif %}
        </div>

        <!-- Improved typography and spacing for mobile -->
        <h3 class="font-semibold text-base sm:text-lg text-slate-900 group-hover:text-[#1e3a8a] 
                   transition-colors pr-20 sm:pr-24 leading-tight">
          {{ course.title }}
        </h3>
        {% if course.description %}
          <p class="mt-2 text-sm sm:text-base text-slate-600 line-clamp-3 leading-relaxed">{{ course.description }}</p>
        {% endif %}
        <div class="mt-3 text-xs text-slate-500 font-medium">
          Created {{ course.created_at|date:"d/m/Y" }}
        </div>
      </a>

      {% if course.processing %}
      <div class="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-100">
        <div class="text-sm text-blue-800 font-medium">
          ‚è≥ Processing in progress‚Ä¶
        </div>
        <div class="text-xs text-blue-600 mt-1">
          This page will update automatically.
        </div>
      </div>
      {% endif %}
    </li>
    {% endfor %}
  </ul>
  {% else %}
    <!-- Enhanced empty state with better mobile design -->
    <div class="bg-white rounded-xl sm:rounded-2xl border-2 border-dashed border-slate-300 p-6 sm:p-8 text-center">
      <div class="text-4xl mb-3">üìö</div>
      <div class="text-slate-600 mb-4">
        <div class="font-medium text-base sm:text-lg">No courses yet</div>
        <div class="text-sm mt-1">Start by uploading your first course</div>
      </div>
      <a class="inline-flex items-center gap-2 text-[#1e3a8a] font-semibold px-4 py-2 rounded-lg hover:bg-blue-50 transition-colors text-sm sm:text-base" 
         href="/upload_course/">
        <span>‚¨ÜÔ∏è</span> Upload your first course
      </a>
    </div>
  {% endif %}
</div>

<style>
  /* Enhanced line clamp with better browser support */
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 3;
    line-clamp: 3;
    overflow: hidden;
  }

  /* Better mobile optimizations */
  @media (max-width: 640px) {
    /* Reduce border radius on very small screens */
    .rounded-xl { border-radius: 12px; }
    .rounded-2xl { border-radius: 16px; }
    
    /* Improve touch targets */
    button, a, input, [role="button"] {
      min-height: 44px;
    }
    
    /* Better text scaling */
    html {
      -webkit-text-size-adjust: 100%;
    }
  }

  /* Enhanced focus states for accessibility */
  input:focus, button:focus, a:focus {
    outline: 2px solid transparent;
    outline-offset: 2px;
  }

  /* Smooth animations for better UX */
  * {
    -webkit-tap-highlight-color: transparent;
  }
</style>

<script>
(function(){
  const plan = "{{ user.subscription|lower }}";
  const label = (document.getElementById('remain-label')?.textContent||'0h 0min').trim();
  const m = label.match(/(\d+)\s*h\s*(\d+)\s*min/i) || [0,0,0];
  const remaining = (+m[1])*60 + (+m[2]);
  const total = (plan==='free') ? 180 : (plan==='student' ? 600 : (plan==='pro' ? 1200 : 600));
  const used = Math.max(0, total - remaining);
  const pct = Math.max(0, Math.min(100, Math.round(used/total*100)));
  
  const bar = document.getElementById('quota-bar');
  const det = document.getElementById('quota-detail');
  
  if (bar) {
    setTimeout(() => bar.style.width = pct + '%', 100);
  }
  
  if (det) {
    const totalHours = Math.floor(total/60);
    const usedHours = Math.floor(used/60);
    const usedMinutes = used % 60;
    det.textContent = `${plan==='free'?'Lifetime':'Monthly'} ${totalHours}h total ‚Ä¢ used ${usedHours}h ${usedMinutes}m (${pct}%)`;
  }

  const input = document.getElementById('course-search');
  const grid = document.getElementById('course-grid');
  
  if(input && grid){
    let searchTimeout;
    input.addEventListener('input', ()=>{
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        const q = input.value.trim().toLowerCase();
        const items = grid.querySelectorAll('li[data-title]');
        let visibleCount = 0;
        
        items.forEach(li => {
          const isVisible = li.dataset.title.includes(q);
          li.style.display = isVisible ? '' : 'none';
          if (isVisible) visibleCount++;
        });
        
        const hasResults = visibleCount > 0;
        grid.style.display = hasResults ? '' : 'none';
      }, 150);
    });
  }

  const anySpin = document.querySelectorAll('#course-grid .animate-spin').length > 0;
  if(anySpin){ 
    console.log('[Dashboard] Auto-refresh scheduled for processing courses');
    setTimeout(()=>location.reload(), 10000); 
  }
})();
</script>

{% endblock %}
